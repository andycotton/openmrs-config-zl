<htmlform formUuid="3959f956-b83a-11e7-abc4-cec278b6b50a"
          formName="HIV Clinical State" formVersion="4.0">

    <style type="text/css">
        <ifMode mode="VIEW" include="false">

            #data-collection {
                display: inline-block;
                width: 58%;
                vertical-align: top;
            }

            .two-columns-legacy {
                column-count: 2;
                -webkit-column-count: 2;
                -moz-column-count: 2;
            }

            /* A div with class="two-columns" must have exactly two children divs */
            .two-columns {
                display: table;
                height: 100%;
                width: 100%;
            }

            .two-columns > div {
                display: table-cell;
                width: 50%;
            }

            p.radio > * {
                display: inline;
                float: none !important;
                min-width: initial;
            }

            form fieldset {
                min-width: 90%;
                display: block;
            }

            .section-container {
                background: #F2F2F2;
                box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
                padding: 10px 5px 10px 15px;
                line-height: 1.5em; /*add this for vertical spacing between elements*/
            }

            .section-container input[type="checkbox"] {
                margin: 0px 5px; /*changed values to vertical, horizontal*/
                top:5px; /*added to offset the checkbox position to line up*/
            }

            .section-container label,
            .section-container-color label {
                margin: 0px;
            }

            .section {
                width: 95%;
            }

            form input[type="radio"], .form input[type="radio"] {
                float: none;
                display: inline-block;
            }

            form label, .form label {
                display: inline-block;
            }

            .side-by-side label {
                display: inline-block;
            }

            .boxed {
                background: #F2F2F2;
                box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
                padding: 10px 5px 10px 15px;
            }
            .dateDatepickerInTheFuture label{
                 display: block;
            }
        </ifMode>
    </style>

<excludeIf velocityTest="$fn.getObs($encounter, 'CIEL:164141')">
<script type="text/javascript">

    jq(document).ready(function() {

        const contextPath = window.location.href.split('/')[3];
        const apiBaseUrl =  "/" + contextPath + "/ws/rest/v1";
        const chwNameConceptUuid = "164141AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
        const patientUuid = '<lookup expression="patient.uuid"/>';

        let currentEncounterDate = new Date();
        let encounterDate = '<lookup expression="encounter.getEncounterDatetime().getTime()"/>';
        if (typeof encounterDate !== "undefined" &amp;&amp; encounterDate !== null &amp;&amp; (encounterDate.length > 0)) {
            currentEncounterDate = new Date(+encounterDate);
        }

        let lastRecordedChw = {
            name: "",
            date: null,
            encounterDisplay: ""
        };

        jq.getJSON(apiBaseUrl + "/obs", {
            concept: chwNameConceptUuid,
            patient: patientUuid,
            v: 'custom:(uuid,display,obsDatetime,value,encounter:(display,encounterDatetime,location:(display),encounterType:(display)))'
          },
          function( data ){
            if (data.results.length > 0) {
                for (let index = 0; index &lt; data.results.length; ++index) {
                    let chwObs = data.results[index];
                    let chwObsDate = new Date(chwObs.obsDatetime);
                    let tmpChwObs = {
                      name: "",
                      date: null,
                      encounterDisplay: ""
                    };
                    if( (currentEncounterDate.getTime() >=  chwObsDate.getTime()) ||
                        (currentEncounterDate.toDateString() === chwObsDate.toDateString())) {
                            if (typeof chwObs.value !== "undefined" &amp;&amp; chwObs.value !== null &amp;&amp; (chwObs.value.length &gt; 0)) {
                                tmpChwObs.name = chwObs.value;
                                tmpChwObs.date = chwObsDate;
                                tmpChwObs.encounterDisplay = chwObs.encounter.display;
                              }
                    }
                    if ( (tmpChwObs.date != null) &amp;&amp;
                        ((lastRecordedChw.date == null) || (lastRecordedChw.date.getTime() &lt; tmpChwObs.date.getTime()) ) ) {

                        lastRecordedChw.name = tmpChwObs.name;
                        lastRecordedChw.date = tmpChwObs.date;
                        lastRecordedChw.encounterDisplay = tmpChwObs.encounterDisplay;
                    }
                }
            }
            if (lastRecordedChw.date != null) {
                  jq("#lastRecordedCHW").text(lastRecordedChw.name);
                  jq("#lastRecordedCHWEncounter").text(lastRecordedChw.encounterDisplay);
                  jq("#lastRecorded-CHW-div").show();
            } else {
                //show the div with the normal obs behaviour
                jq("#normal-CHW-div").show();
            }
          });

          jq("#changeChw").on('change', function(){

            if (this.checked === true) {
                jq("#editChwNameDiv").show();
            } else {
                jq("#editChwNameDiv").hide();
            }
          });
    });
</script>
</excludeIf>

    <ifMode mode="VIEW" include="false" >
        <h3>
            <uimessage code="pihcore.hiv.clinicalState.short"/>
        </h3>
        <script type="text/javascript">
            jq(function() {
                setUpEdd(
                    '<lookup expression="encounter.getEncounterDatetime().getTime()"/>',
                    '<uimessage code="pihcore.weeks"/>'
                );

                setUpDatepickerStartAndEndDateValidation();
                setUpObsWithObsDateTime('syph-checkbox');

                // handlers for next and submit buttons, see nextAndSubmitButtons.js
                setUpNextAndSubmitButtons();
            });
        </script>
    </ifMode>

    <!-- Program enrollment (if the patient hasn't already been enrolled);
         use first ancestor location tagged as Program Location -->
    <enrollInProgram programId="HIV" locationTag="Program Location"/>

    <section id="chwName-section" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.chw">
        <div class="section-container">
            <div id="chw-name-details">
                <p id="chw-name">

                    <includeIf velocityTest="$fn.getObs($encounter, 'CIEL:164141')">
                        <label>
                            <uimessage code="pihcore.nameCHW"/>:
                        </label>
                        <obs id="chwName" conceptId="CIEL:164141"/>
                    </includeIf>

                    <excludeIf velocityTest="$fn.getObs($encounter, 'CIEL:164141')">
                        <div id="lastRecorded-CHW-div" style="display: none">
                            <label>
                                <uimessage code="pihcore.last.recorded.nameCHW"/>:
                            </label>
                            <span id="lastRecordedCHW" class="value"></span>
                            <br/>
                            <label><uimessage code="general.fromDate"/>:</label>
                            <span id="lastRecordedCHWEncounter" class="value"></span>
                            <br/>
                            <ifMode mode="EDIT" include="true">
                                <div>
                                    <label>
                                        <uimessage code="pihcore.change.nameCHW"/>?
                                    </label>
                                    <input type="checkbox" id="changeChw" name="changeChw"/>
                                    <label for="changeChw"><uimessage code="coreapps.yes"/></label>
                                </div>
                                <div id="editChwNameDiv" style="display: none">
                                    <label>
                                        <uimessage code="pihcore.nameCHW"/>:
                                    </label>
                                    <obs id="chwName" conceptId="CIEL:164141"/>
                                </div>
                            </ifMode>
                        </div>
                        <div id="normal-CHW-div" style="display: none">
                            <label>
                                <uimessage code="pihcore.nameCHW"/>:
                            </label>
                            <obs id="chwName" conceptId="CIEL:164141"/>
                        </div>
                    </excludeIf>


                </p>
            </div>
        </div>
    </section>

    <!-- UHM-4784 Use Lab results or workflow to enter lab data.  Using includeif to comment out the section -->
    <includeIf velocityTest="$patient.gender == 'NoLabEntryHere' ">
        <section id="hiv-surveillance" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.labSurveillance">
            <div class="section-container">
                <table>
                    <tr>
                        <th></th>
                        <th colspan="2">
                            <label>
                                <uimessage code="pihcore.result"/>
                            </label>
                        </th>
                        <th>
                            Date
                        </th>
                    </tr>

                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="CIEL:1361">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle" colspan="2">
                                        <span class="small">
                                            <obs conceptId="{concept}" showUnits="true"/>
                                        </span>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:730" name="cd4Percent"/>
                        <render concept="CIEL:5497" name="cd4Count"/>
                    </repeat>

                    <!-- Viral Load -->
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:HIV viral load construct">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <span class="small">
                                            <obs conceptId="{concept}" showUnits="true"/>
                                        </span>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="CIEL:1305" style="checkbox"
                                             answerConceptId="CIEL:1306" answerCode="LDL"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:856" name="viralLoad"/>
                    </repeat>

                    <!-- TB resistance -->
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="CIEL:1361">
                                <tr>
                                    <td>
                                        <obs conceptId="CIEL:162087"
                                             answerConceptId="{concept}"
                                             answerCode="pihcore.lab.{name}"
                                             style="checkbox"
                                             toggle="{id: '{name}-lab-toggle', style: 'dim'}"/>
                                    </td>
                                    <td id="{name}-lab-toggle" colspan="2">
                                        <obs conceptId="{concept}"/>
                                    </td>
                                    <td id="{name}-lab-toggle">
                                        <obs conceptId="PIH:3267"/>
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:307" name="tbSmear"/>
                    </repeat>
                </table>
            </div>
        </section>
    </includeIf>

    <!-- only show these sections if the patient is < 12 years old-->
    <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &lt; 12">
        <section id="hiv-state-stage" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.hiv.clinicalStage">
            <div class="boxed">
                <p>
                    <label>
                        <uimessage code="pihcore.hiv.whoStages"/>
                    </label>
                    <obs conceptId="PIH:CURRENT WHO HIV STAGE"
                         answerConceptIds="CIEL:1204,CIEL:1205,CIEL:1206,CIEL:1207"
                         answerLabels="1,2,3,4" style="radio"/>
                </p>
            </div>
        </section>

        <section id="feeding" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.feedingAndVaccination" >
            <div class="section-container">
                <p>
                    <label>
                        <uimessage code="pihcore.specifyTypeFeeding"/>
                    </label>
                    <br/>
                    <obs conceptId="CIEL:1151"
                         answerConceptIds="CIEL:5526,CIEL:5254,CIEL:6046" style="radio"
                         answerCodes="zl.breastfeedExclusively,pihcore.formulaExclusively,zl.mixedFeeding"
                         answerSeparator="" />
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.providedFormula"/>
                    </label>
                    <obs conceptId="PIH:3581" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.mch.counselling.breastfeeding"/>
                    </label>
                    <obs conceptId="CIEL:1910" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.foodBefore6months"/>
                    </label>
                    <obs conceptId="CIEL:5633" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>

                <p class="radio">
                    <label>
                        <uimessage code="pihcore.formulaPrepTraining"/>
                    </label>
                    <obs conceptId="CIEL:159880" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>


                <label>
                    <uimessage code="pihcore.vaccinated"/>
                </label>
                <p class="side-by-side">
                    <obs id="vaccinate" conceptId="CIEL:164134" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066,CIEL:1067"
                         answerSeparator="" >
                        <controls>
                            <when value="CIEL:1065" thenDisplay="#vaccinationCard" />
                        </controls>
                    </obs>
                </p>
                <div id="vaccinationCard">
                    <p>
                        <strong>
                            <uimessage code="pihcore.ifYesVaccinationCard"/>
                        </strong>
                    </p>
                </div>

                <p>
                    <label>
                        <uimessage code="pihcore.childWeaned" />
                    </label>
                    <obs conceptId="CIEL:1152" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066"/>
                </p>
            </div>
        </section>

    </includeIf>

    <section id="id-treatment" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.currentTreatment">
        <div class="section-container">
            <!-- ARV Treatment -->
            <h4>
                <uimessage code="pihcore.arvTreatment"/>
            </h4>

            <p class="side-by-side">
                <!-- ToDo: Add reverse toggle for none -->
                <obs id="takingARVs"
                     conceptId="CIEL:160117" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1107"
                     answerCodes="emr.yes,pihcore.none.label">
                    <controls>
                        <when value="CIEL:1065" thenDisplay="#current-arvs"/>
                    </controls>
                </obs>
            </p>

            <div id="current-arvs">
                <obsgroup groupingConceptId="PIH:13156">
                    <label>
                        <uimessage code="pihcore.hiv.startDateARV"/>
                    </label>
                    <p class="small">
                        <obs conceptId="CIEL:159599"/>
                    </p>
                    <div class="two-columns">
                        <p class="radio">
                            <!-- ARV medications  -->

                                <div>
                                    <label>
                                        <uimessage code="pihcore.regimen"/>:
                                    </label>
                                    <obs id="currentARV1" conceptId="CIEL:1282"
                                        answerConceptIds="
                                        CIEL:160124,
                                        CIEL:1652,
                                        CIEL:164511,
                                        CIEL:162561,
                                        CIEL:165086,
                                        CIEL:164505,
                                        CIEL:162565,
                                        CIEL:164512,
                                        CIEL:162201,
                                        CIEL:5622"
                                        answerCodes="
                                        AZT + 3TC + EFV,
                                        AZT + 3TC + NVP,
                                        AZT + 3TC + ATV/r,
                                        AZT + 3TC + LPR/r,
                                        TDF + 3TC + DTG,
                                        TDF + 3TC + EFV,
                                        TDF + 3TC + NVP,
                                        TDF + 3TC + ATV/r,
                                        TDF + 3TC + LPV/r,pihcore.other" />
                                </div>
                                <div>
                                    <!-- Other ARV -->
                                    <label>
                                        <uimessage code="pihcore.other"/>
                                        ARV:
                                    </label>
                                    <obs conceptId="CIEL:5424"/>
                                    <br/>

                                    <!-- Treatment line -->
                                    <label>
                                        <uimessage code="pihcore.treatmentLine"/>
                                    </label>
                                    <obs conceptId="PIH:13115" style="radio"
                                        answerConceptIds="PIH:7428,PIH:7429,PIH:7430"/>
                                </div>
                        </p>
                    </div>
                </obsgroup>
            </div>


            <h4>
                <uimessage code="pihcore.antiTbTreatment"/>
            </h4>

            <div  class="two-columns">
                <div>
                    <p class="side-by-side">
                        <obs id="takingAntiTB"
                            conceptId="CIEL:159798" style="radio"
                            answerConceptIds="CIEL:1065,CIEL:1066"
                            answerCodes="emr.yes,pihcore.none.label" >
                            <controls>
                                <when value="CIEL:1065" thenDisplay=".current-tb-meds"/>
                            </controls>
                        </obs>
                    </p>

                    <div class="current-tb-meds">
                        <label>
                            <uimessage code="pihcore.startDate" />
                        </label>
                        <obs conceptId="CIEL:1113" />
                    </div>
                </div>
                <div class="current-tb-meds">
                    <p class="radio">
                        <obs conceptId="CIEL:1111" style="radio"
                            answerConceptIds="PIH:2406,PIH:2408,CIEL:159909"
                            answerCodes="pihcore.tb.initialTreatment,pihcore.tb.retreatment,pihcore.tb.mdrtbTreatment"
                            answerSeparator="&lt;br /&gt;"/>
                        <obs conceptId="CIEL:160136" size="14" />
                    </p>
                    <p>
                        <obs conceptId="PIH:Anti TB free text" labelCode="zl.ifOtherSpecify" />
                    </p>
                </div>
            </div>

            <h4>
                <uimessage code="pihcore.prophylaxis"/>
            </h4>

            <table>
                <tr>
                    <td>
                        <label>
                            <uimessage code="pihcore.treatment" />
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.startDate" />
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.endDate" />
                        </label>
                    </td>
                </tr>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr class="startDateEndDate">
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" class="startDate"/>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" class="endDate"/>
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:105281" drugname="Cotrimoxazole" />
                </repeat>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr class="startDateEndDate">
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                    <p class="radio {drugname}-current-treat">
                                        <obs conceptId="PIH:13786" style="radio"
                                             answerConceptIds="CIEL:159943, CIEL:159944" />
                                    </p>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" class="startDate" />
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" class="endDate" />
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:78280"  drugname="Isoniazide" />
                </repeat>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:2739">
                            <tr class="startDateEndDate">
                                <td>
                                    <obs conceptId="PIH:2289" answerConceptId="{conceptMap}"
                                         answerLabel="{drugname}"
                                         toggle="{id: '{drugname}-current-treat', style: 'dim'}"/>
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:163526" class="startDate" />
                                </td>
                                <td class="{drugname}-current-treat">
                                    <obs conceptId="CIEL:164384" allowFutureDates="true" class="endDate"/>
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render conceptMap="CIEL:76488"  drugname="Fluconazole" />
                    <render conceptMap="CIEL:74250"  drugname="Dapsone" />
                </repeat>

                <obsgroup groupingConceptId="PIH:2739">
                    <tr class="startDateEndDate">
                        <td>
                            <obs conceptId="PIH:2289"
                                 answerConceptId="PIH:3120" answerCode="pihcore.other"
                                 toggle="{id: '{other-current-pro-treat}', style: 'dim'}"
                                 commentFieldLabel="specify:" />
                        </td>
                        <td class="other-current-pro-treat">
                            <obs conceptId="CIEL:163526" class="startDate" />
                        </td>
                        <td class="other-current-pro-treat">
                            <obs conceptId="CIEL:164384" allowFutureDates="true" class="endDate"/>
                        </td>
                    </tr>
                </obsgroup>
            </table>

            <h4>
                <uimessage code="pihcore.otherMeds"/>
            </h4>

            <p>
                <obs conceptId="PIH:13318" style="text"/>
            </p>

        </div>
    </section>

    <section id="complaint" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.chiefComplaint.title">
        <div class="section-container">
            <p>
                <obs conceptId="CIEL:160531" style="textarea" id="chief-complaint"/>
            </p>
        </div>
    </section>

    <style>
        .tb-screening-question * {
            display: inline;
            float: none !important;
            min-width: initial;
            vertical-align: middle;
        }

        .tb-screening-question-label {
            display:block;
        }

        .tb-screening-question {
            margin-bottom: 10px;
        }

        .tb-screening-result-section.tb-screening-result-label {
            display: inline-block;
        }
        .tb-screening-result-section select {
            display: inline-block;
        }
        .tb-screening-result-section input.hasDatepicker {
            display: inline-block;
            width: 200px;
            min-width: 100px;
        }
    </style>

    <script type="text/javascript">
        jq(document).ready(function() {
            // Only show the TB screening result question if it has been answered.  Only collected historically
            var showTbScreening = (typeof getValue !== 'undefined' &amp;&amp; getValue('tbScreeningResultQuestion.value')); // Edit mode
            showTbScreening = showTbScreening || (typeof getValue === 'undefined' &amp;&amp; jq('.tb-screening-result-section').find('.value').length > 0); // View mode
            if (showTbScreening) {
                jq('.tb-screening-result-section').show();
            }
            else {
                jq('.tb-screening-result-section').hide();
            }
        });
    </script>

    <section id="tb-screen" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.tbscreen.title">
        <div class="section-container">
            <div class="two-columns-legacy">
                <repeat with="['feverSweats','11565'],['wtLoss3kg','11566'],['cough','11567'],['tbContact','11568'],['painfulNodes','11569'],['bloodyCough','970'],['dyspnea','5960'],['chestPain','136']">
                    <div class="radio tb-screening-question">
                        <obs conceptIds="PIH:11563,PIH:11564"
                             answerConceptId="PIH:{1}"
                             labelCode="pihcore.tbscreen.{0}"
                             labelCssClass="tb-screening-question-label"
                             conceptLabels="coreapps.yes,coreapps.no"
                             style="radio" />
                    </div>
                </repeat>
            </div>
            <div class="tb-screening-result-section">
                <obs id="tbScreeningResultQuestion" conceptId="CIEL:160108"
                     answerConceptIds="CIEL:703,CIEL:664"
                     labelCode="pihcore.tbscreen.screeningTestResult"
                     labelCssClass="tb-screening-result-label"
                     conceptLabels="coreapps.positive,coreapps.negative"
                     showDate="true" />
            </div>
            <br/>
            <p>
                <label>
                    <uimessage code="pihcore.tbSuspectedMessage" />
                </label>
            </p>
        </div>
    </section>

    <section id="radiology-findings" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.rad_findings.title">
        <div class="section-container">
            <!-- Use PACS at HUM -->
            <repeat with="['Chest (X-ray)','CIEL:165152','chestXRay'],
                          ['Pelvic (U/S)', 'CIEL:161283', 'pelvicUS'],
                          ['Abdominal (U/S)','CIEL:845','abUS']">
                <p>
                    <obsgroup groupingConceptId="PIH:Radiology report construct">
                        <obs conceptId="PIH:Radiology procedure performed"
                             answerConceptId="{1}" toggle="{2}"
                             answerCode="pihcore.rad.{2}"
                             style="checkbox"/>
                        <div id="{2}" class="two-columns">
                            <obs conceptId="PIH:Radiology report comments"
                                 labelCode="pihcore.findings.label" />
                            <obs conceptId="PIH:12847" labelCode="Date" />
                        </div>
                    </obsgroup>
                </p>
            </repeat>
        </div>
    </section>

    <section id="sexual-activity" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="zl.consultNote.sexualActivities.label">
        <div class="section-container">
            <div class="two-columns">
                <div>
                    <p class="radio">
                        <label>
                            <uimessage code="zl.sexuallyActive"/>?
                        </label>
                        <obs conceptId="CIEL:160109"
                            answerConceptIds="CIEL:1065,CIEL:1066" style="radio"/>
                    </p>
                </div>

                <div>
                    <p class="radio">
                        <label>
                            <uimessage code="pihcore.familyPlanning.title"/>?
                        </label>
                        <obs conceptId="CIEL:1382" style="checkbox"
                            answerConceptId="CIEL:1065" toggle="fp-table" />
                    </p>
                </div>
            </div>

            <table id="fp-table">
                <tr>
                    <td>
                        <label>
                            <uimessage code="pihcore.familyPlanning.method"/>
                        </label>
                    </td>
                    <td>
                        <label>
                            <uimessage code="pihcore.startDate"/>
                        </label>
                    </td>
                </tr>

                <repeat>
                    <template>
                        <obsgroup groupingConceptId="PIH:Family planning construct">
                            <tr>
                                <td id="{comment}-fp">
                                    <obs conceptId="CIEL:374"
                                         answerConceptId="{fpMethod}"
                                         style="checkbox"
                                         toggle="{id: '{comment}-date', style: 'dim'}"
                                    />
                                </td>
                                <td class="{comment}-date">
                                    <obs conceptId="CIEL:163757"/>
                                </td>
                            </tr>
                        </obsgroup>
                    </template>
                    <render fpMethod="CIEL:780" comment="Pill"/>
                    <render fpMethod="CIEL:907" comment="Depo-provera"/>
                    <render fpMethod="CIEL:190" comment="Condoms"/>
                    <render fpMethod="CIEL:78796" comment="Norplant"/>
                    <render fpMethod="CIEL:5275" comment="IUD"/>
                    <render fpMethod="CIEL:1472" comment="TubalLigation"/>
                    <render fpMethod="CIEL:1489" comment="Vasectomy"/>
                </repeat>

                <!-- Other family planning -->
                <obsgroup groupingConceptId="PIH:Family planning construct">
                    <tr>
                        <td>
                            <obs conceptId="CIEL:374"
                                 answerConceptId="CIEL:5622"
                                 style="checkbox"
                                 toggle="{id: 'other-fp', style: 'dim'}"
                            />
                        </td>
                        <td class="other-fp">
                            <obs conceptId="CIEL:163757"/>
                        </td>
                    </tr>
                </obsgroup>
                <tr>
                    <td align="left" class="other-fp">
                        <label>
                            <uimessage code="zl.ifOtherSpecify"/>
                        </label>
                        <obs conceptId="PIH:2996" size="30"/>
                    </td>
                    <td></td>
                </tr>
            </table>

            <includeIf velocityTest="$patient.gender == 'F' ">
                <br/>
                <!-- Pregnant -->
                <p>
                    <obs conceptId="CIEL:5272" toggle="pregnant"
                         answerConceptId="CIEL:1065"
                         answerCode="pihcore.pregnant"
                         style="checkbox"/>

                    <div id="pregnant">
                        <div class="two-columns">
                            <div>
                                <!-- Last menstrual period (LMP or DDR) -->
                                <p>
                                    <label>
                                        <uimessage code="pihcore.pregnancy.lastPeriod"/>
                                    </label>
                                    <span class="small">
                                        <obs id="lastPeriodDate" conceptId="CIEL:1427" />
                                    </span>
                                </p>
                            </div>

                            <!-- Due date (DPA) -->
                            <div>
                                <p>
                                    <label>
                                        <uimessage code="pihcore.pregnancy.dueDate"/>
                                    </label>
                                    <span class="small">
                                        <obs id="edd" conceptId="CIEL:5596" allowFutureDates="true"/>
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="two-columns hidden calculated-edd-and-gestational" style="display: none;">
                            <div>
                                <span id="calculated-gestational-age-wrapper">
                                    <span id="calculated-gestational-age-label">
                                        <uimessage code="pihcore.calculatedGestationalAge"/>:&#160;
                                    </span>
                                    <span id='calculated-gestational-age-value' class="calculated-gestational-age-value value"></span>
                                </span>
                            </div>
                            <div>
                                <span id="calculated-edd-wrapper">
                                    <span id="calculated-edd-label">
                                        <uimessage code="pihcore.calculatedEstimatedDeliveryDate"/>:&#160;
                                    </span><br/>
                                    <span id='calculated-edd' class="calculated-edd value"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </p>
            </includeIf>

        </div>
    </section>

    <!-- This section for Females and HIV followup form -->
    <includeIf velocityTest="$encounter.encounterType.uuid == 'c31d3312-40c4-11e7-a919-92ebcb67fe33'">
        <includeIf velocityTest="$patient.gender == 'F' ">
            <section id="id-breastfeeding" sectionTag="fieldset" headerTag="legend"
                     headerStyle="title" headerCode="zl.maternalBreastfeeding">
                <div class="section-container">
                    <p class="side-by-side">
                        <obs id="breastfeeding-mom" conceptId="CIEL:985" style="radio"
                             answerConceptIds="PIH:CURRENTLY,CIEL:1152"
                             answerCodes="pihcore.currently,zl.breastfeedStopped">
                            <controls>
                                <when value="CIEL:1152" thenDisplay="#wean-date"/>
                            </controls>
                        </obs>
                    </p>
                    <div id="wean-date">
                        <label>
                            <uimessage code="zl.weanDate"/>
                        </label>
                        <obs conceptId="CIEL:166566"/>
                    </div>
                </div>
            </section>
            <br/>
        </includeIf>
    </includeIf>

    <!-- this section for PMTCT followup -->
    <includeIf velocityTest="$encounter.encounterType.uuid == '95e03e7d-9aeb-4a99-bd7a-94e8591ec2c5'">
        <section id="syphilis-section" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="Syphilis">

            <div class="section-container">
                <p>
                    <obs id="syph-checkbox" conceptId="CIEL:164801" style="checkbox"
                         answerConceptId="CIEL:1065" answerCode="pihcore.screeningSyph"
                         dateLabel="&lt;br&gt;Date" toggle="syph-screen" />
                </p>
                <p id="syph-screen" class="side-by-side">
                    <label>
                        <uimessage code="pihcore.lab.syphilis"/>
                    </label>
                <br/>
                    <obs conceptId="CIEL:165303" style="radio"
                         answerConceptIds="CIEL:703,CIEL:664,CIEL:1138,PIH:3083"/>
                </p>
                <hr/>

                <div class="two-columns">
                    <div>
                        <obsgroup groupingConceptId="CIEL:166557">
                            <p>
                                <obs conceptId="CIEL:1628" style="checkbox" answerConceptId="CIEL:112493"
                                     answerCode="pihcore.syphilisTreatmentPregnantMother" toggle="mom-syph-treat"/>
                            </p>
                            <p id="mom-syph-treat" class="startDateEndDate">
                                <obs id="mom-syph-treat-start" conceptId="CIEL:163526" labelCode="pihcore.treatmentStartDate" class="startDate"/>
                                <obs id="mom-syph-treat-end" conceptId="CIEL:164384" labelCode="pihcore.treatmentEndDate" class="endDate"/>
                            </p>
                        </obsgroup>
                    </div>

                    <div>
                        <obsgroup groupingConceptId="CIEL:166558">
                            <p>
                                <obs conceptId="CIEL:1628" style="checkbox" answerConceptId="CIEL:112493"
                                     answerCode="pihcore.syphilisTreatmentPartner" toggle="partner-syph-treat"/>
                            </p>
                            <p id="partner-syph-treat" class="startDateEndDate">
                                <obs id="partner-syph-treat-start" conceptId="CIEL:163526" labelCode="pihcore.treatmentStartDate" class="startDate"/>
                                <obs id="partner-syph-treat-end" conceptId="CIEL:164384" labelCode="pihcore.treatmentEndDate" class="endDate"/>
                            </p>
                        </obsgroup>
                    </div>
                </div>
            </div>

        </section>
    </includeIf>


    <section id="psych" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.psycState">
        <div class="section-container">
            <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &gt; 12 || $patient.getAge($encounter.getEncounterDatetime()) == 12 || (! $patient.age)">
                <p class="radio">
                    <label>
                        <uimessage code="pihcore.receivedPostTestCounsel" />
                    </label>
                    <obs conceptId="CIEL:159382" answerConceptIds="CIEL:1066,CIEL:1065"
                         style="radio" />
                </p>

                <p>
                    <label>
                        <uimessage code="pihcore.patientReceivedAdvice" />
                    </label>
                    <br/>

                    <repeat>
                        <template>
                            <obs conceptId="CIEL:163560"
                                 answerConceptId="{response}"
                                 answerCode="{text}"
                                 style="checkbox" />
                            <br/>
                        </template>
                        <render response="CIEL:151185" text="pihcore.cervicalCancerScreeningTreatment"/>
                        <render response="CIEL:165489" text="pihcore.lowRiskBehavior" />
                        <render response="CIEL:1382"   text="pihcore.fpCounseling" />
                        <render response="CIEL:163559" text="pihcore.stiScreening" />
                        <render response="CIEL:159381" text="pihcore.partnerScreening" />
                    </repeat>
                </p>
            </includeIf>

            <p class="radio">
                <label>
                    <uimessage code="pihcore.referredMH" />
                </label>
                <obs conceptId="PIH:13002" answerConceptIds="CIEL:1066,CIEL:1065"
                     answerSeparator="" style="radio" />

            </p>
        </div>
    </section>

    <section id="hiv-adherence" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.arvAdherence">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.med.rxDosesMonth" />
            </label>
            <obs conceptId="PIH:13067" />
            <br/>

            <label>
                <uimessage code="pihcore.med.missedDosesMonth" />
            </label>
            <obs conceptId="CIEL:160110" />
            <br/>

            <p class="side-by-side">
                <label>
                    <uimessage code="pihcore.dailyCHWvisit" />
                </label>
                <obs id="chwVisit"
                     conceptId="CIEL:160111" style="radio"
                     answerConceptIds="CIEL:1065,CIEL:1066">
                    <controls>
                        <when value="CIEL:1066" thenDisplay="#reason-without-chw"/>
                    </controls>
                </obs>
            </p>

            <div id="reason-without-chw">
                <label>
                    <uimessage code="pihcore.ifNotSpecifyReason" />
                </label>
                <obs conceptId="PIH:13065"  />
            </div>
        </div>
    </section>

    <section id="hiv-adverse-event" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.adverseEvent">
        <div class="section-container">
            <div id="ae">
                <table>
                    <tr>
                        <th>
                            <label>
                                <uimessage code="pihcore.adverseEvent"/>
                            </label>
                        </th>
                        <th>
                            <label>
                                Date
                            </label>
                        </th>
                    </tr>

                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:ADVERSE EFFECT CONSTRUCT">
                                <tr>
                                    <td id="{name}-ae">
                                        <obs conceptId="PIH:ADVERSE EFFECT"
                                             answerConceptId="{concept}"
                                             style="checkbox"
                                             toggle="{id: '{name}-ae-date', style: 'dim'}" />
                                    </td>
                                    <td id="{name}-ae-date">
                                        <obs conceptId="PIH:1300" />
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:1107"   name="None"/>
                        <render concept="CIEL:118983" name="Neuropathy"/>
                        <render concept="CIEL:136162" name="LacticAcidosis" />
                        <render concept="CIEL:133473" name="NauseaVomiting" />
                        <render concept="CIEL:116986" name="Hepatitis" />
                        <render concept="CIEL:121629" name="Anemia"/>
                        <render concept="CIEL:136443" name="Jaundice"/>
                        <render concept="CIEL:512"    name="Rash" />
                    </repeat>
                    <repeat>
                        <template>
                            <obsgroup groupingConceptId="PIH:ADVERSE EFFECT CONSTRUCT">
                                <tr>
                                    <td id="{name}-ae">
                                        <obs conceptId="PIH:ADVERSE EFFECT"
                                             answerConceptId="{concept}"
                                             style="checkbox"
                                             commentFieldLabel="(prciser)"
                                             toggle="{id: '{name}-ae-date', style: 'dim'}" />
                                    </td>
                                    <td id="{name}-ae-date">
                                        <obs conceptId="PIH:1300" />
                                    </td>
                                </tr>
                            </obsgroup>
                        </template>
                        <render concept="CIEL:5622" name="Other" />
                    </repeat>
                </table>
            </div>
        </div>
    </section>

    <section id="hiv-progress" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.progress">
        <div class="boxed">
            <p>
                <label>
                    <uimessage code="pihcore.hiv.clinicalState.short"/>
                </label>
                <obs conceptId="CIEL:160116"
                     answerConceptIds="PIH:GOOD,PIH:SATISFACTORY,CIEL:162679,PIH:DETERIORATION"
                     style="radio" />
            </p>
        </div>
    </section>

    <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) &gt; 12 || $patient.getAge($encounter.getEncounterDatetime()) == 12 || (! $patient.age)">
        <section id="hiv-state-stage" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.hiv.clinicalStage">
            <div class="boxed">
                <p>
                    <label>
                        <uimessage code="pihcore.hiv.whoStages"/>
                    </label>
                    <obs conceptId="PIH:CURRENT WHO HIV STAGE"
                         answerConceptIds="CIEL:1204,CIEL:1205,CIEL:1206,CIEL:1207"
                         answerLabels="1,2,3,4" style="radio" />
                </p>

                <!-- UHM-4784 Use Lab results or workflow to enter lab data.  Using includeif to comment out the section -->
                <includeIf velocityTest="$patient.gender == 'NoLabEntryHere' ">
                    <!-- ToDo:  Duplicate of section A.  Valery says this is different and used to calculate stage.  -->
                    <obsgroup groupingConceptId="PIH:3434">
                        <obs conceptId="CIEL:5497" labelCode="pihcore.lab.cd4Count"/>
                        <br/>
                        <obs conceptId="PIH:10783" labelCode="CD4 Date:" />
                    </obsgroup>
                </includeIf>
            </div>
        </section>
    </includeIf>

    <section id="hiv-oi" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.oi.title">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.hiv.enterOI"/>
            </label>
            <br/>

            <div class="two-columns-legacy">
                <repeat with="['One'],
                              ['Two'],
                              ['Three'],
                              ['Four']">
                    <obsgroup groupingConceptId="PIH:Visit Diagnoses" showIfEmpty="false">
                        <obs conceptId="PIH:DIAGNOSIS"
                             answerConceptSetIds="PIH:HUM opportunistic infection"
                             style="autocomplete"/>
                    </obsgroup>
                </repeat>
            </div>
        </div>
    </section>
    <includeIf velocityTest="$encounter.encounterType.uuid == '95e03e7d-9aeb-4a99-bd7a-94e8591ec2c5'">
        <section id="id-ev-treatment-cont" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.evaluation">
            <div class="section-container">
                <div>
                    <p class="side-by-side">
                        <label>
                            <uimessage code="pihcore.dailyDoseARV" />
                        </label>
                        <obs id="daily-dose-arv" conceptId="PIH:13649" style="radio"
                             answerConceptIds="CIEL:1065,CIEL:1066">
                            <controls>
                                <when value="CIEL:1066" thenDisplay="#side-by-side-reason"/>
                            </controls>
                        </obs>
                    </p>
                    <p id="side-by-side-reason" style="display:none">
                        <obs conceptId="PIH:1709" labelCode="pihcore.ifNotSpecifyReason"/>
                    </p>
                    <p>
                        <obs conceptId="CIEL:160110" labelCode="pihcore.missingDosesPerMonth"/>
                    </p>
                    <p class="side-by-side">
                        <obs conceptId="PIH:13654" style="radio"
                             labelCode="pihcore.dailyDoseOfCTX"
                             answerConceptIds="CIEL:1065,CIEL:1066"/>
                    </p>
                    <p class="side-by-side">
                        <obs conceptId="CIEL:160111" style="radio"
                             labelCode="pihcore.dailyCHWvisit"
                             answerConceptIds="CIEL:1065,CIEL:1066"/>
                    </p>
                    <p class="side-by-side">
                        <obs conceptId="CIEL:5586" style="radio"
                             labelCode="pihcore.successfulCounselingTreatment"
                             answerConceptIds="CIEL:1065,CIEL:1066"/>
                    </p>
                </div>

            </div>

        </section>
    </includeIf>
    <br/>

    <!-- this section for PMTCT followup only -->
    <includeIf velocityTest="$encounter.encounterType.uuid == '95e03e7d-9aeb-4a99-bd7a-94e8591ec2c5'">
        <section id="id-breastfeeding" sectionTag="fieldset" headerTag="legend"
                 headerStyle="title" headerCode="zl.maternalBreastfeeding">
            <div class="section-container">
                <p id="feeding-status" class="side-by-side">
                    <label>
                        <uimessage code="zl.breastfeedingSinceLastVisit" />
                    </label>
                    <obs id="breast-since-visit"
                         conceptId="PIH:6981" style="radio"
                         answerConceptIds="CIEL:1065,CIEL:1066">
                        <controls>
                            <when value="CIEL:1065" thenDisplay="#bf-status"/>
                        </controls>
                    </obs>
                </p>
                <p id="bf-status" class="side-by-side">
                    <obs id="breastfeeding-mom" conceptId="CIEL:985" style="radio"
                         answerConceptIds="CIEL:5526,CIEL:6046,CIEL:1152"
                         answerCodes="pihcore.exclusively,zl.mixed,zl.breastfeedStopped">
                        <controls>
                            <when value="CIEL:1152" thenDisplay="#wean-date"/>
                        </controls>
                    </obs>
                </p>
                <div id="wean-date">
                    <label>
                        <uimessage code="zl.weanDate" />
                    </label>
                    <obs conceptId="CIEL:166566" />
                </div>
            </div>
        </section>
        <br/>
    </includeIf>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <button id="next" type="button" class="submitButton confirm right">
                <uimessage code="emr.next"/>
                <i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i>
            </button>
            <button id="submit" class="submitButton confirm right">
                <uimessage code="mirebalais.save"/>
                <i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i>
            </button>
            <button id="cancel" type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
